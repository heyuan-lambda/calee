{% extends "base.html" %}

{% block title %}CalEE - 拍照识别{% endblock %}

{% block content %}
<div x-data="uploadPage()" x-init="initUpload()" class="max-w-lg mx-auto">
    <header class="bg-white p-4 shadow-sm">
        <h1 class="text-xl font-bold">拍照识别食物</h1>
        <p class="text-sm text-gray-500 mt-1">拍摄食物照片，AI 自动识别热量</p>
    </header>

    <main class="p-4">
        <!-- 上传区域 -->
        <div class="bg-white rounded-2xl p-6 shadow-sm mb-4">
            <div
                @click="$refs.fileInput.click()"
                @dragover.prevent
                @drop.prevent="handleDrop"
                class="border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition"
                :class="previewImage ? 'border-primary-500 bg-primary-50' : 'border-gray-300 hover:border-primary-400'"
            >
                <input type="file" x-ref="fileInput" @change="handleFileSelect" accept="image/*" class="hidden">

                <!-- 预览图 -->
                <div x-show="previewImage" class="mb-4">
                    <img :src="previewImage" class="max-h-64 mx-auto rounded-lg">
                </div>

                <!-- 上传提示 -->
                <div x-show="!previewImage">
                    <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="camera" class="w-8 h-8 text-primary-500"></i>
                    </div>
                    <p class="font-medium text-gray-700 mb-2">点击或拖拽上传图片</p>
                    <p class="text-sm text-gray-500">支持 JPG、PNG 格式，最大 5MB</p>
                </div>

                <!-- 重新上传 -->
                <div x-show="previewImage" class="flex justify-center gap-3">
                    <button
                        @click.stop="$refs.fileInput.click()"
                        class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm"
                    >
                        重新选择
                    </button>
                    <button
                        @click.stop="clearPreview"
                        class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm"
                    >
                        清除
                    </button>
                </div>
            </div>

            <!-- 识别按钮 -->
            <button
                @click="recognizeFood"
                :disabled="!previewImage || recognizing"
                class="w-full mt-4 py-3 bg-primary-500 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed transition"
            >
                <span x-show="!recognizing">开始识别</span>
                <span x-show="recognizing">识别中...</span>
            </button>
        </div>

        <!-- 识别结果 -->
        <div x-show="recognizedFoods.length > 0" class="space-y-3">
            <h2 class="font-semibold text-gray-700">识别结果</h2>

            <template x-for="(food, index) in recognizedFoods" :key="index">
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg" x-text="food.name"></h3>
                            <p class="text-sm text-gray-500">置信度: <span x-text="Math.round(food.confidence * 100)"></span>%</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-primary-600" x-text="Math.round(food.estimated_calories)"></p>
                            <p class="text-xs text-gray-500">卡路里</p>
                        </div>
                    </div>

                    <!-- 宏量营养素 -->
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="bg-orange-50 rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-500">碳水</p>
                            <p class="font-medium text-orange-600" x-text="food.estimated_macros.carbohydrates + 'g'"></p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-500">蛋白质</p>
                            <p class="font-medium text-red-600" x-text="food.estimated_macros.protein + 'g'"></p>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-500">脂肪</p>
                            <p class="font-medium text-yellow-600" x-text="food.estimated_macros.fat + 'g'"></p>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex gap-2">
                        <button
                            @click="addFoodToMeal(food)"
                            class="flex-1 py-2 bg-primary-500 text-white rounded-lg text-sm font-medium"
                        >
                            添加到记录
                        </button>
                        <button
                            @click="saveAsCustomFood(food)"
                            class="py-2 px-4 bg-gray-100 text-gray-600 rounded-lg text-sm"
                        >
                            保存
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- 错误提示 -->
        <div x-show="errorMessage" class="bg-red-50 border border-red-200 rounded-xl p-4 text-red-600">
            <p x-text="errorMessage"></p>
        </div>
    </main>

    <!-- 选择餐食弹窗 -->
    <div
        x-show="showMealSelector"
        class="fixed inset-0 bg-black/50 flex items-end justify-center z-50"
        x-cloak
    >
        <div class="bg-white w-full max-w-lg rounded-t-3xl p-6 slide-up">
            <h3 class="text-lg font-semibold mb-4">选择添加到哪一餐</h3>
            <div class="space-y-2">
                <template x-for="mealType in ['breakfast', 'lunch', 'dinner', 'snack']" :key="mealType">
                    <button
                        @click="addToMeal(mealType)"
                        class="w-full py-3 bg-gray-100 rounded-xl text-left px-4 hover:bg-gray-200 transition"
                    >
                        <span x-text="getMealLabel(mealType)"></span>
                    </button>
                </template>
            </div>
            <button
                @click="showMealSelector = false"
                class="w-full mt-4 py-3 text-gray-500"
            >
                取消
            </button>
        </div>
    </div>
</div>

<script>
function uploadPage() {
    return {
        previewImage: null,
        selectedFile: null,
        recognizing: false,
        recognizedFoods: [],
        errorMessage: '',
        showMealSelector: false,
        pendingFood: null,

        async initUpload() {
            lucide.createIcons();
        },

        handleFileSelect(event) {
            const file = event.target.files[0];
            this.processFile(file);
        },

        handleDrop(event) {
            const file = event.dataTransfer.files[0];
            this.processFile(file);
        },

        processFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                this.errorMessage = '请选择图片文件';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                this.errorMessage = '图片大小不能超过 5MB';
                return;
            }

            this.selectedFile = file;
            this.errorMessage = '';

            const reader = new FileReader();
            reader.onload = (e) => {
                this.previewImage = e.target.result;
            };
            reader.readAsDataURL(file);
        },

        clearPreview() {
            this.previewImage = null;
            this.selectedFile = null;
            this.recognizedFoods = [];
            this.errorMessage = '';
        },

        async recognizeFood() {
            if (!this.selectedFile) return;

            this.recognizing = true;
            this.errorMessage = '';
            this.recognizedFoods = [];

            try {
                const formData = new FormData();
                formData.append('file', this.selectedFile);

                const response = await fetch('/api/v1/upload/recognize', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    this.recognizedFoods = result.data.foods;
                } else {
                    this.errorMessage = result.message || '识别失败，请重试';
                }
            } catch (error) {
                this.errorMessage = '识别失败，请检查网络连接';
                console.error(error);
            } finally {
                this.recognizing = false;
            }
        },

        addFoodToMeal(food) {
            this.pendingFood = food;
            this.showMealSelector = true;
        },

        async addToMeal(mealType) {
            if (!this.pendingFood) return;

            try {
                const response = await fetch('/api/v1/meals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        meal_type: mealType,
                        entries: [{
                            food_id: 0, // 需要先创建食物
                            servings: this.pendingFood.suggested_servings,
                        }]
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('已添加到' + this.getMealLabel(mealType));
                    this.showMealSelector = false;
                }
            } catch (error) {
                console.error(error);
            }
        },

        async saveAsCustomFood(food) {
            try {
                const response = await fetch('/api/v1/foods', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: food.name,
                        calories_per_serving: food.estimated_calories,
                        carbohydrates: food.estimated_macros.carbohydrates,
                        protein: food.estimated_macros.protein,
                        fat: food.estimated_macros.fat,
                        serving_size: 100,
                        serving_unit: 'g',
                        category: 'other',
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('食物已保存');
                }
            } catch (error) {
                console.error(error);
            }
        },

        getMealLabel(type) {
            const labels = { breakfast: '早餐', lunch: '午餐', dinner: '晚餐', snack: '零食' };
            return labels[type];
        }
    };
}
</script>
{% endblock %}
