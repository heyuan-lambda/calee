{% extends "base.html" %}

{% block title %}CalEE - 首页{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="initDashboard()" class="max-w-lg mx-auto">
    <!-- 顶部问候区 -->
    <header class="bg-gradient-to-br from-primary-500 to-primary-600 text-white p-6 rounded-b-3xl shadow-lg">
        <div class="flex items-center justify-between mb-4">
            <div>
                <p class="text-primary-100 text-sm" x-text="getGreeting()"></p>
                <h1 class="text-2xl font-bold">欢迎使用 CalEE</h1>
            </div>
            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                <i data-lucide="user" class="w-6 h-6"></i>
            </div>
        </div>

        <!-- 日期选择器 -->
        <div class="flex items-center gap-3">
            <button @click="changeDate(-1)" class="p-2 hover:bg-white/10 rounded-full transition">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
            </button>
            <span class="flex-1 text-center font-medium" x-text="formatDate(selectedDate)"></span>
            <button @click="changeDate(1)" :disabled="isToday()" class="p-2 hover:bg-white/10 rounded-full transition disabled:opacity-30">
                <i data-lucide="chevron-right" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="p-4 space-y-4">
        <!-- 圆形进度卡片 -->
        <div class="bg-white rounded-2xl p-6 shadow-sm slide-up">
            <div class="flex items-center justify-center gap-8">
                <!-- 圆形进度条 -->
                <div class="relative">
                    <svg class="w-40 h-40" viewBox="0 0 160 160">
                        <circle
                            cx="80" cy="80" r="70"
                            fill="none"
                            stroke="#e5e7eb"
                            stroke-width="12"
                        />
                        <circle
                            class="progress-ring-circle"
                            cx="80" cy="80" r="70"
                            fill="none"
                            :stroke="getProgressColor(summary.calories_used_percentage)"
                            stroke-width="12"
                            stroke-linecap="round"
                            :stroke-dasharray="circumference"
                            :stroke-dashoffset="getProgressOffset(summary.calories_used_percentage)"
                        />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-4xl font-bold" :class="getTextColor(summary.calories_used_percentage)" x-text="Math.round(summary.total_calories)"></span>
                        <span class="text-sm text-gray-500">/ <span x-text="summary.calorie_goal"></span> 卡</span>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-500">剩余</p>
                        <p class="text-2xl font-semibold text-primary-600" x-text="Math.round(summary.calories_remaining)"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">完成度</p>
                        <p class="text-2xl font-semibold" :class="getTextColor(summary.calories_used_percentage)" x-text="Math.round(summary.calories_used_percentage) + '%'"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 宏量营养素卡片 -->
        <div class="grid grid-cols-3 gap-3">
            <div class="bg-white rounded-xl p-4 shadow-sm text-center slide-up" style="animation-delay: 0.1s">
                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="wheat" class="w-5 h-5 text-orange-500"></i>
                </div>
                <p class="text-sm text-gray-500">碳水</p>
                <p class="font-bold text-lg" x-text="Math.round(summary.macros.carbohydrates) + 'g'"></p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm text-center slide-up" style="animation-delay: 0.15s">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="drumstick" class="w-5 h-5 text-red-500"></i>
                </div>
                <p class="text-sm text-gray-500">蛋白质</p>
                <p class="font-bold text-lg" x-text="Math.round(summary.macros.protein) + 'g'"></p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm text-center slide-up" style="animation-delay: 0.2s">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="droplet" class="w-5 h-5 text-yellow-500"></i>
                </div>
                <p class="text-sm text-gray-500">脂肪</p>
                <p class="font-bold text-lg" x-text="Math.round(summary.macros.fat) + 'g'"></p>
            </div>
        </div>

        <!-- 餐食记录区 -->
        <div class="space-y-3">
            <!-- 早餐 -->
            <template x-for="mealType in ['breakfast', 'lunch', 'dinner', 'snack']" :key="mealType">
                <div class="bg-white rounded-xl p-4 shadow-sm card-hover slide-up" style="animation-delay: 0.3s">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" :class="getMealIconBg(mealType)">
                                <i :data-lucide="getMealIcon(mealType)" class="w-5 h-5" :class="getMealIconColor(mealType)"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold" x-text="getMealLabel(mealType)"></h3>
                                <p class="text-sm text-gray-500" x-text="getMealCalories(mealType)"></p>
                            </div>
                        </div>
                        <a :href="'/meals/' + mealType + '/add'" class="text-primary-600">
                            <i data-lucide="plus-circle" class="w-6 h-6"></i>
                        </a>
                    </div>

                    <!-- 食物列表 -->
                    <div x-show="getMealFoods(mealType).length > 0" class="space-y-2">
                        <template x-for="food in getMealFoods(mealType)" :key="food.id">
                            <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                                <div class="flex items-center gap-3">
                                    <img :src="food.image_url || '/static/images/food-placeholder.png'" class="w-12 h-12 rounded-lg object-cover bg-gray-100">
                                    <div>
                                        <p class="font-medium" x-text="food.name"></p>
                                        <p class="text-sm text-gray-500" x-text="food.servings + ' 份 × ' + Math.round(food.calories) + ' 卡'"></p>
                                    </div>
                                </div>
                                <span class="text-sm font-medium text-primary-600" x-text="Math.round(food.calories) + ' 卡'"></span>
                            </div>
                        </template>
                    </div>

                    <!-- 空状态 -->
                    <div x-show="getMealFoods(mealType).length === 0" class="text-center py-4 text-gray-400">
                        <i data-lucide="plus" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="text-sm">点击 + 添加食物</p>
                    </div>
                </div>
            </template>
        </div>
    </main>
</div>

<script>
function dashboard() {
    return {
        selectedDate: new Date(),
        circumference: 2 * Math.PI * 70,
        summary: {
            total_calories: 0,
            calorie_goal: 1200,
            calories_remaining: 1200,
            calories_used_percentage: 0,
            macros: { carbohydrates: 0, protein: 0, fat: 0 },
            meals: { breakfast: [], lunch: [], dinner: [], snack: [] }
        },

        async initDashboard() {
            await this.loadSummary();
            lucide.createIcons();
        },

        async loadSummary() {
            try {
                const dateStr = this.formatDateForAPI(this.selectedDate);
                const response = await fetch(`/api/v1/dashboard/summary?date=${dateStr}`);
                const result = await response.json();
                if (result.success) {
                    this.summary = result.data;
                }
            } catch (error) {
                console.error('加载摘要失败:', error);
            }
        },

        getGreeting() {
            const hour = new Date().getHours();
            if (hour < 6) return '夜深了';
            if (hour < 9) return '早上好';
            if (hour < 12) return '上午好';
            if (hour < 14) return '中午好';
            if (hour < 18) return '下午好';
            if (hour < 22) return '晚上好';
            return '夜深了';
        },

        formatDate(date) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return '今天';
            if (date.toDateString() === tomorrow.toDateString()) return '明天';

            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            return `${month}月${day}日 ${weekdays[date.getDay()]}`;
        },

        formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },

        changeDate(days) {
            this.selectedDate.setDate(this.selectedDate.getDate() + days);
            this.selectedDate = new Date(this.selectedDate);
            this.loadSummary();
        },

        isToday() {
            return this.selectedDate.toDateString() === new Date().toDateString();
        },

        getProgressOffset(percentage) {
            const clamped = Math.min(100, Math.max(0, percentage));
            return this.circumference - (clamped / 100) * this.circumference;
        },

        getProgressColor(percentage) {
            if (percentage >= 100) return '#ef4444';
            if (percentage >= 80) return '#f59e0b';
            return '#22c55e';
        },

        getTextColor(percentage) {
            if (percentage >= 100) return 'text-red-500';
            if (percentage >= 80) return 'text-amber-500';
            return 'text-primary-600';
        },

        getMealLabel(type) {
            const labels = { breakfast: '早餐', lunch: '午餐', dinner: '晚餐', snack: '零食' };
            return labels[type];
        },

        getMealIcon(type) {
            const icons = { breakfast: 'sun', lunch: 'cloud-sun', dinner: 'moon', snack: 'cookie' };
            return icons[type];
        },

        getMealIconBg(type) {
            const bgs = { breakfast: 'bg-orange-100', lunch: 'bg-blue-100', dinner: 'bg-purple-100', snack: 'bg-pink-100' };
            return bgs[type];
        },

        getMealIconColor(type) {
            const colors = { breakfast: 'text-orange-500', lunch: 'text-blue-500', dinner: 'text-purple-500', snack: 'text-pink-500' };
            return colors[type];
        },

        getMealFoods(type) {
            return this.summary.meals[type]?.flatMap(meal => meal.entries.map(entry => ({
                ...entry.food,
                servings: entry.servings,
                calories: entry.calories
            }))) || [];
        },

        getMealCalories(type) {
            const foods = this.getMealFoods(type);
            const total = foods.reduce((sum, food) => sum + food.calories, 0);
            return total > 0 ? `${Math.round(total)} 卡路里` : '暂无记录';
        }
    };
}
</script>
{% endblock %}
