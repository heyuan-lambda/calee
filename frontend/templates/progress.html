{% extends "base.html" %}

{% block title %}CalEE - 进度统计{% endblock %}

{% block content %}
<div x-data="progressPage()" x-init="initProgress()" class="max-w-lg mx-auto">
    <header class="bg-white p-4 shadow-sm">
        <h1 class="text-xl font-bold">进度统计</h1>
        <p class="text-sm text-gray-500 mt-1">查看您的饮食记录和趋势</p>
    </header>

    <main class="p-4 space-y-4">
        <!-- 周概览 -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="font-semibold mb-3">本周概览</h3>
            <div class="flex justify-between">
                <template x-for="day in weekDays" :key="day.date">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 mb-2" x-text="day.label"></p>
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium"
                             :class="getDayColor(day.percentage)"
                             x-text="day.percentage + '%'">
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- 卡路里趋势图 -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="font-semibold mb-3">卡路里趋势</h3>
            <div class="h-40 flex items-end justify-between gap-1">
                <template x-for="(day, index) in weekDays" :key="index">
                    <div class="flex-1 flex flex-col items-center">
                        <div class="w-full rounded-t"
                             :style="`height: ${Math.min(100, day.percentage)}%; background: ${getBarColor(day.percentage)}`">
                        </div>
                        <p class="text-xs text-gray-500 mt-1" x-text="day.shortLabel"></p>
                    </div>
                </template>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <p class="text-sm text-gray-500">平均热量</p>
                <p class="text-2xl font-bold text-primary-600" x-text="averageCalories"></p>
                <p class="text-xs text-gray-400">卡/天</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <p class="text-sm text-gray-500">达标天数</p>
                <p class="text-2xl font-bold text-green-500" x-text="goalMetDays"></p>
                <p class="text-xs text-gray-400">天</p>
            </div>
        </div>

        <!-- 历史记录 -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <h3 class="font-semibold mb-3">历史记录</h3>
            <div class="space-y-3">
                <template x-for="day in history" :key="day.date">
                    <a :href="'/?date=' + day.date" class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                        <div>
                            <p class="font-medium" x-text="formatDate(day.date)"></p>
                            <p class="text-sm text-gray-500" x-text="getDayLabel(day.date)"></p>
                        </div>
                        <div class="text-right">
                            <p class="font-medium" :class="day.percentage <= 100 ? 'text-primary-600' : 'text-red-500'" x-text="Math.round(day.calories) + ' 卡'"></p>
                            <p class="text-sm text-gray-500" x-text="Math.round(day.percentage) + '%'"></p>
                        </div>
                    </a>
                </template>
            </div>
        </div>
    </main>
</div>

<script>
function progressPage() {
    return {
        weekDays: [],
        history: [],
        averageCalories: 0,
        goalMetDays: 0,

        async initProgress() {
            await this.loadWeekData();
            lucide.createIcons();
        },

        async loadWeekData() {
            const today = new Date();
            const days = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);

                const dateStr = this.formatDateForAPI(date);
                const percentage = await this.loadDayPercentage(dateStr);

                days.push({
                    date: dateStr,
                    label: this.getDayLabel(date),
                    shortLabel: this.getShortDayLabel(date),
                    percentage: percentage,
                });
            }

            this.weekDays = days;
            this.calculateStats();
        },

        async loadDayPercentage(dateStr) {
            try {
                const response = await fetch(`/api/v1/dashboard/summary?date=${dateStr}`);
                const result = await response.json();
                if (result.success) {
                    this.history.push({
                        date: dateStr,
                        calories: result.data.total_calories,
                        percentage: result.data.calories_used_percentage,
                    });
                    return Math.round(result.data.calories_used_percentage);
                }
            } catch (error) {
                console.error(error);
            }
            return 0;
        },

        calculateStats() {
            const validDays = this.history.filter(d => d.calories > 0);
            if (validDays.length > 0) {
                const sum = validDays.reduce((s, d) => s + d.calories, 0);
                this.averageCalories = Math.round(sum / validDays.length);
            }
            this.goalMetDays = this.history.filter(d => d.percentage > 0 && d.percentage <= 100).length;
        },

        getDayColor(percentage) {
            if (percentage === 0) return 'bg-gray-100 text-gray-400';
            if (percentage > 100) return 'bg-red-100 text-red-500';
            if (percentage >= 80) return 'bg-amber-100 text-amber-600';
            return 'bg-primary-100 text-primary-600';
        },

        getBarColor(percentage) {
            if (percentage > 100) return '#ef4444';
            if (percentage >= 80) return '#f59e0b';
            return '#22c55e';
        },

        getDayLabel(date) {
            const today = new Date();
            const d = typeof date === 'string' ? new Date(date) : date;

            if (d.toDateString() === today.toDateString()) return '今天';

            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            if (d.toDateString() === tomorrow.toDateString()) return '明天';

            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            return weekdays[d.getDay()];
        },

        getShortDayLabel(date) {
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            return weekdays[date.getDay()];
        },

        formatDate(date) {
            const d = typeof date === 'string' ? new Date(date) : date;
            return `${d.getMonth() + 1}/${d.getDate()}`;
        },

        formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    };
}
</script>
{% endblock %}
